# Packages
email-filtering-pkg.i : postfix-pkg.i dovecot-pkg.i
	# 'rar', 'unrar', and 'lha' are missing in this package list (not in the repos)
	$(apt_install) amavisd-new clamav-daemon clamav-freshclam spamassassin opendkim postfix-policyd-spf-python pyzor razor arj cabextract cpio nomarch pax zip
    - require:
      - pkg: postfix-pkg
      - pkg: dovecot-imapd
      - pkg: dovecot-pop3d
#      - pkg: dovecot-managesieved

# Config
adduser amavis clamav:
  cmd:
    - run
    - unless: getent group clamav | sed 's/[^:]*://' | grep amavis
    - require:
      - pkg: amavisd-new
      - pkg: clamav-daemon

adduser clamav amavis:
  cmd:
    - run
    - unless: getent group amavis | sed 's/[^:]*://' | grep clamav
    - require:
      - pkg: amavisd-new
      - pkg: clamav-daemon

/etc/amavis/conf.d/15-content_filter_mode:
  file:
    - managed
    - source: salt://email-filtering/15-content_filter_mode
    - require:
      - pkg: amavisd-new

/etc/amavis/conf.d/20-debian_defaults:
  file:
    - managed
    - source: salt://email-filtering/20-debian_defaults
    - require:
      - pkg: amavisd-new

/etc/amavis/conf.d/50-user:
  file:
    - managed
    - source: salt://email-filtering/50-user.jinja
    - template: jinja
    - require:
      - pkg: amavisd-new

/etc/default/spamassassin:
  file:
    - managed
    - source: salt://email-filtering/spamassassin
    - require:
      - pkg: spamassassin

# Services
amavis:
  service:
    - running
    - require:
      - pkg: amavisd-new
    - watch:
      - cmd: adduser amavis clamav
      - cmd: adduser clamav amavis
      - file: /etc/amavis/conf.d/15-content_filter_mode
      - file: /etc/amavis/conf.d/20-debian_defaults
      - file: /etc/amavis/conf.d/50-user
    - watch_in:
      - service: postfix-service
      - service: dovecot

clamav-daemon:
  service:
    - running
    - require:
      - pkg: clamav-daemon
    - watch:
      - cmd: adduser amavis clamav
      - cmd: adduser clamav amavis
    - watch_in:
      - service: postfix-service
      - service: dovecot

clamav-freshclam:
  service:
    - running
    - require:
      - pkg: clamav-freshclam
    - watch_in:
      - service: postfix-service
      - service: dovecot

spamassassin-service:
  service:
    - running
    - name: spamassassin
    - watch:
      - file: /etc/default/spamassassin
    - watch_in:
      - service: postfix-service
      - service: dovecot
