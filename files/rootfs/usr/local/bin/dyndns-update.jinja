#!/bin/bash

USERNAME={{ username }}
PASSWORD={{ password }}
HOST={{ dyndomain }}
SERVER={{ server }}

#
# Now for the actual work
#

HOST_IP=$(dig {{ dyndomain }} | grep "^{{ dyndomain }}" | awk '{ print $5 }')
CURRENT_IP=$(wget -O - 'http://checkip.dyndns.org/' 2>/dev/null | sed -e 's/.*Address: \([^<]*\).*/\1/')

if [ -f /tmp/ip_{{ dyndomain }} ]
then
        OLD_IP=$(cat /tmp/ip_{{ dyndomain }})
fi

#
# Don't update unless ip has changed or resolved ip is different from ours
#

if [ "x"${CURRENT_IP} = "x"${OLD_IP} ]
then
  if [ "x"${HOST_IP} = "x"${CURRENT_IP} ]
  then
    exit
  fi
fi

echo "IP changed from " $OLD_IP " to " $CURRENT_IP
echo "Saving new IP"
echo $CURRENT_IP > /tmp/ip_{{ dyndomain }}

echo "Updating " $HOST " to " $CURRENT_IP
wget -O - "http://${USERNAME}:${PASSWORD}@${SERVER}/nic/update?system=dyndns&hostname=${HOST}&myip=${CURRENT_IP}&wildcard=NOCHG&mx=NOCHG&backmx=NOCHG" 2>/dev/null
echo ""
